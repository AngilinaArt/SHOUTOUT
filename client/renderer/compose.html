<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate" />
    <meta
      http-equiv="Pragma"
      content="no-cache" />
    <meta
      http-equiv="Expires"
      content="0" />
    <title>Shoutout – Send Toast</title>
      <style>
      :root {
        --bg: #1f2937;
        --panel: #374151;
        --muted: #9ca3af;
        --ring: #6b7280;
        --ok: #10b981;
        --warn: #f59e0b;
        --crit: #ef4444;
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: rgba(
          29,
          33,
          40,
          0.6
        ); /* Noch transparenter für mehr Glaseffekt */
        backdrop-filter: blur(25px); /* Noch stärkerer Glaseffekt */
        color: #afc6f3;
        display: flex;
        align-items: stretch;
        border-radius: 12px; /* Rundungen wie andere Komponenten */
        overflow: hidden; /* Für saubere Rundungen */
        border: 1px solid rgba(175, 198, 243, 0.15); /* Subtiler Cursor accent border */
      }
      .wrap {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 28px;
        width: 100%;
        height: 100%;
        justify-content: flex-start;
      }
      .header {
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #afc6f3;
        text-shadow: 0 0 10px rgba(175, 198, 243, 0.3);
      }
      .field {
        background: rgba(29, 33, 40, 0.6); /* Cursor dark + mehr Transparenz */
        backdrop-filter: blur(12px); /* Glaseffekt */
        border: 1px solid rgba(175, 198, 243, 0.2); /* Cursor accent border */
        border-radius: 12px; /* Konsistente Rundungen */
        padding: 18px; /* Etwas mehr Padding */
        position: relative;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3),
          0 0 0 1px rgba(175, 198, 243, 0.1); /* Glaseffekt shadows */
      }
      .toolbar {
        position: absolute;
        top: 6px;
        right: 8px;
        display: flex;
        gap: 6px;
      }
      .btn-emoji {
        border: 0;
        background: rgba(175, 198, 243, 0.15); /* Cursor accent */
        backdrop-filter: blur(8px); /* Glaseffekt */
        color: #afc6f3; /* Cursor accent color */
        border-radius: 8px;
        padding: 6px 10px; /* Etwas mehr Padding */
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(175, 198, 243, 0.2); /* Subtiler Border */
      }

      .btn-emoji:hover {
        background: rgba(175, 198, 243, 0.25); /* Cursor accent hover */
        backdrop-filter: blur(12px); /* Stärkerer Glaseffekt */
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(175, 198, 243, 0.2); /* Cursor accent shadow */
      }
      .emoji-panel {
        position: absolute;
        top: 36px;
        right: 8px;
        width: 240px;
        background: rgba(30, 27, 75, 0.95);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 10px;
        padding: 6px;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 4px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
      }
      .emoji-panel.hidden {
        display: none;
      }
      .emoji-item {
        font-size: 18px;
        line-height: 1;
        padding: 6px;
        border: 0;
        background: transparent;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .emoji-item:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: scale(1.1);
      }
      /* Remove heavy focus effect to keep broadcast tag unobstructed */
      .field:focus-within {
        outline: none;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3),
          0 0 0 1px rgba(175, 198, 243, 0.1);
        backdrop-filter: blur(12px);
      }
      textarea {
        width: 100%;
        border: none;
        outline: none;
        resize: vertical;
        min-height: 180px;
        font-size: 14px;
        background: transparent;
        color: #e2e8f0;
        font-family: inherit;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .col {
        flex: 1;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="number"],
      select {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 10px;
        padding: 10px 12px;
        color: #e2e8f0;
      }
      .pills {
        display: flex;
        gap: 8px;
      }
      .pill {
        user-select: none;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(118, 104, 149, 0.3);
        cursor: pointer;
        font-size: 12px;
        color: #e2e8f0;
        opacity: 0.8;
        transition: all 0.2s ease;
      }
      .pill.active {
        border-color: #22173d;
        background: rgba(139, 92, 246, 0.2);
        opacity: 1;
      }
      .pill.warn.active {
        border-color: var(--warn);
        background: rgba(245, 158, 11, 0.15);
      }
      .pill.crit.active {
        border-color: var(--crit);
        background: rgba(239, 68, 68, 0.15);
      }
      .meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      /* Broadcast indicators */
      .compose-field-wrap { position: relative; }
      .broadcast-tag {
        display: none;
        position: absolute;
        top: -12px; /* original floating position above the field */
        left: 8px;
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
        border: 1px solid rgba(245, 158, 11, 0.35);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: .2px;
        box-shadow: 0 2px 8px rgba(0,0,0,.2);
        z-index: 9999; /* stay above focus rings/shadows */
        pointer-events: none;
      }
      .broadcast-active #broadcastTag { display: inline-flex; }

      @keyframes glowPulse {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5); }
        100% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
      }
      .glow-once { animation: glowPulse 650ms ease-out 1; }
      .btn-warn { border-color: rgba(245,158,11,.6) !important; }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }
      .actions-inline {
        margin-top: 6px;
        margin-bottom: 12px;
        justify-content: center; /* Center buttons for this inline action bar */
        gap: 12px;
      }
      button {
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .btn-secondary {
        background: rgba(175, 198, 243, 0.1); /* Cursor accent */
        backdrop-filter: blur(10px); /* Glaseffekt */
        color: #afc6f3; /* Cursor text color */
        border: 1px solid rgba(175, 198, 243, 0.2); /* Cursor border */
        transition: all 0.2s ease;
        border-radius: 12px; /* Konsistente Rundungen */
        padding: 12px 18px; /* Larger touch target */
        min-width: 128px; /* More prominent width */
        font-size: 15px;
      }

      .btn-secondary:hover {
        background: rgba(175, 198, 243, 0.2); /* Cursor accent hover */
        backdrop-filter: blur(14px); /* Stärkerer Glaseffekt */
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(175, 198, 243, 0.2); /* Cursor shadow */
      }

      .btn-primary {
        background: rgba(
          175,
          198,
          243,
          0.8
        ); /* Cursor accent mit mehr Opacity */
        backdrop-filter: blur(12px); /* Glaseffekt */
        color: #1d2128; /* Dunkler Text auf hellem Cursor accent */
        border: 1px solid rgba(175, 198, 243, 0.9); /* Cursor border */
        transition: all 0.2s ease;
        box-shadow: 0 6px 20px rgba(175, 198, 243, 0.3); /* Cursor shadow */
        border-radius: 12px; /* Konsistente Rundungen */
        font-weight: 600; /* Stärkerer Text */
        padding: 12px 18px; /* Larger touch target */
        min-width: 140px; /* Slightly wider primary */
        font-size: 15px;
      }

      .btn-primary:hover {
        background: rgba(175, 198, 243, 0.9); /* Stärkerer Cursor accent */
        backdrop-filter: blur(16px); /* Stärkerer Glaseffekt */
        border-color: rgba(175, 198, 243, 1); /* Vollständiger Cursor border */
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(175, 198, 243, 0.4); /* Stärkerer Cursor shadow */
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Match overlay bubble look for compose */
      .compose-bubble {
        position: relative;
        color: #afc6f3;
        border-radius: 12px;
        padding: 14px 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(175, 198, 243, 0.15);
        backdrop-filter: blur(10px);
        border: none; /* override .field default border */
      }
      .compose-bubble:after {
        content: "";
        position: absolute;
        top: 10px;
        right: -6px;
        width: 0; height: 0;
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
      }
      /* Severity accent like overlay */
      .severity-blue.compose-bubble {
        background:
          linear-gradient(135deg, rgba(59,130,246,0.14), rgba(59,130,246,0) 60%),
          rgba(29,33,40,0.85);
        border-left: 3px solid #3b82f6;
      }
      .severity-blue.compose-bubble:after { border-left: 6px solid rgba(29,33,40,0.85); }
      .severity-green.compose-bubble {
        background:
          linear-gradient(135deg, rgba(16,185,129,0.14), rgba(16,185,129,0) 60%),
          rgba(29,33,40,0.85);
        border-left: 3px solid #10b981;
      }
      .severity-green.compose-bubble:after { border-left: 6px solid rgba(29,33,40,0.85); }
      .severity-pink.compose-bubble {
        background:
          linear-gradient(135deg, rgba(236,72,153,0.16), rgba(236,72,153,0) 60%),
          rgba(29,33,40,0.85);
        border-left: 3px solid #ec4899;
      }
      .severity-pink.compose-bubble:after { border-left: 6px solid rgba(29,33,40,0.85); }
      .severity-red.compose-bubble {
        background:
          linear-gradient(135deg, rgba(239,68,68,0.16), rgba(239,68,68,0) 60%),
          rgba(29,33,40,0.85);
        border-left: 3px solid #ef4444;
      }
      .severity-red.compose-bubble:after { border-left: 6px solid rgba(29,33,40,0.85); }

      /* Toast-like actions/buttons */
      .toast-actions { display: flex; gap: 8px; margin-top: 8px; justify-content: center; }
      .toast-btn {
        padding: 10px 18px;
        border: none;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      .toast-ok {
        background: rgba(255,255,255,0.1);
        color: #afc6f3;
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
      }
      .toast-ok:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.3);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      .toast-reply {
        background: rgba(175, 198, 243, 0.2);
        color: #ffffff;
        border: 1px solid rgba(175, 198, 243, 0.3);
        backdrop-filter: blur(10px);
      }
      .toast-reply:hover {
        background: rgba(175, 198, 243, 0.3);
        border-color: rgba(175, 198, 243, 0.4);
        box-shadow: 0 4px 12px rgba(175, 198, 243, 0.2);
      }

      /* Spoiler toggle (prominent) */
      .spoiler-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(139, 92, 246, 0.12);
        border: 1px solid rgba(139, 92, 246, 0.25);
        box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.1);
      }
      .spoiler-label { display: flex; align-items: center; gap: 12px; cursor: pointer; }
      .spoiler-checkbox { transform: scale(1.25); accent-color: #8b5cf6; }
      .spoiler-text { font-size: 15px; font-weight: 600; color: #e9eaf5; letter-spacing: 0.2px; }
      .spoiler-hint { font-size: 12px; color: #b7b9c7; opacity: 0.9; }

      /* User-Auswahl Styles */
      .target-select {
        width: 100%;
        background: rgba(29, 33, 40, 0.55); /* dezenter */
        backdrop-filter: blur(8px);
        border: 1px solid rgba(175, 198, 243, 0.18);
        border-radius: 12px;
        padding: 8px 10px; /* kompakter */
        color: #afc6f3;
        font-size: 13px; /* eine Spur kleiner */
        line-height: 1.2;
        font-family: inherit;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18);
        transition: all 0.2s ease;
        outline: none;
        appearance: none;
      }

      /* Windows-spezifische Dropdown-Styles */
      .target-select option {
        background: #1e1b4b !important;
        color: #e2e8f0 !important;
        padding: 6px 10px;
        border-radius: 8px; /* weicher, soweit unterstützt */
        background-clip: padding-box;
      }

      /* Hover-Effekt für Optionen */
      .target-select option:hover {
        background: #312e81 !important;
      }

      /* Focus-Effekt für Optionen */
      .target-select option:focus {
        background: #3730a3 !important;
      }

      /* Selected Option */
      .target-select option:checked {
        background: rgba(139, 92, 246, 0.28) !important; /* weicher */
        color: #ffffff !important;
        border: 1px solid rgba(139, 92, 246, 0.38);
      }

      /* Schlanker Scrollbar für die Auswahl */
      .target-select::-webkit-scrollbar { width: 6px; }
      .target-select::-webkit-scrollbar-track { background: rgba(0,0,0,0.15); border-radius: 8px; }
      .target-select::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.35); border-radius: 8px; }
      .target-select::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.5); }

      .refresh-link {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .refresh-link:hover {
        opacity: 1;
        text-decoration: underline;
      }

      .user-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 4px rgba(16, 185, 129, 0.3);
      }

      .user-status.offline {
        background: #94a3b8;
        box-shadow: 0 0 4px rgba(148, 163, 184, 0.3);
      }

      /* Secondary bubble styling for recipient block */
      .compose-bubble.secondary {
        padding: 10px 12px;
        background: rgba(29, 33, 40, 0.72);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(175, 198, 243, 0.12);
        border-left: 2px solid rgba(175, 198, 243, 0.24);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">Send Toast</div>
      <div class="compose-field-wrap">
        <div class="field compose-bubble severity-blue" id="composeField">
          <div class="toolbar">
          <button
            type="button"
            id="emojiBtn"
            title="Emoji"
            class="btn-emoji">
            😊
          </button>
          <div
            id="emojiPanel"
            class="emoji-panel hidden"
            role="menu"
            aria-hidden="true"></div>
        </div>
        <textarea
          id="message"
          placeholder="Deine Nachricht… (Enter = senden)"></textarea>
        <div class="meta">
          <span id="counter">0 / 280</span>
        </div>
        <div class="spoiler-toggle">
          <label class="spoiler-label">
            <input type="checkbox" id="spoiler" class="spoiler-checkbox" />
            <span class="spoiler-text">Nachricht spoilern</span>
          </label>
        </div>
        </div>
        <div id="broadcastTag" class="broadcast-tag hidden" aria-hidden="true">📣 An alle</div>
      </div>

      <!-- Farben direkt unter dem Eingabefeld -->
      <div class="row">
        <div class="col">
          <div class="label">Farbe</div>
          <div class="pills" id="sev-pills">
            <div class="pill active" data-sev="blue">blue</div>
            <div class="pill" data-sev="green">green</div>
            <div class="pill" data-sev="pink">pink</div>
            <div class="pill crit" data-sev="red">red</div>
          </div>
        </div>
      </div>

      <!-- Actions moved up for better UX -->
      <div class="actions actions-inline toast-actions">
        <button class="btn-secondary toast-btn toast-ok" id="cancel">ABBRECHEN</button>
        <button class="btn-primary toast-btn toast-reply" id="send" disabled>SENDEN</button>
      </div>

      <!-- Neue User-Auswahl in kleiner Bubble -->
      <div class="field compose-bubble secondary">
        <div class="label">Empfänger</div>
        <select
          id="target"
          class="target-select"
          multiple
          size="3">
          <option value="all">👥 Alle User</option>
          <option
            value="loading"
            disabled>
            🔄 Lade User...
          </option>
        </select>
        <div class="meta">
          <span id="userCount">0 User online • Mehrfachauswahl: Cmd/Ctrl-Klick</span>
          <span
            id="refreshUsers"
            class="refresh-link"
            >🔄 Aktualisieren</span
          >
        </div>
      </div>

      <!-- actions moved above -->
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const messageEl = $("message");
      const sendBtn = $("send");
      const counter = $("counter");
      const pills = document.getElementById("sev-pills");
      const emojiBtn = document.getElementById("emojiBtn");
      const emojiPanel = document.getElementById("emojiPanel");
      const targetEl = $("target");
      const userCountEl = $("userCount");
      const refreshUsersEl = $("refreshUsers");
      const spoilerEl = $("spoiler");

      // User-Management
      let users = [];
      let currentUser = null;
      let onlineCount = 0;

      function isBroadcast() {
        const selected = Array.from(targetEl.selectedOptions).map(o => o.value);
        return selected.length === 0 || selected.includes('all');
      }

      function updateBroadcastUI({ flash = false } = {}) {
        const active = isBroadcast();
        document.body.classList.toggle('broadcast-active', active);
        // Button label
        sendBtn.textContent = active ? 'AN ALLE SENDEN' : 'SENDEN';
        // Placeholder
        messageEl.placeholder = active
          ? 'Deine Nachricht… (wird an alle gesendet)'
          : 'Deine Nachricht… (Enter = senden)';
        // Chip text
        const tag = document.getElementById('broadcastTag');
        if (tag) { tag.textContent = onlineCount > 0 ? `📣 An alle (${onlineCount})` : '📣 An alle'; }
        // Subtle glow
        if (flash && active) {
          [sendBtn, document.getElementById('composeField')].forEach(el => {
            if (!el) return;
            el.classList.add('glow-once');
            setTimeout(() => el.classList.remove('glow-once'), 700);
          });
        }
      }

      async function loadUsers() {
        try {
          // Lade User über IPC (kein CORS-Problem)
          users = await window.compose.loadUsers();
          // Lade aktuellen User-Namen
          currentUser = await window.compose.getCurrentUser();
          updateUserDropdown();
        } catch (error) {
          console.warn("Could not load users:", error);
          setDefaultUsers();
        }
      }

      function setDefaultUsers() {
        users = [];
        currentUser = null;
        updateUserDropdown();
      }

      function updateUserDropdown() {
        // Merke bisherige Auswahl (für Refresh)
        const prevSelected = new Set(
          Array.from(targetEl.selectedOptions).map((o) => o.value)
        );

        // Entferne alle User-Optionen außer den Standard-Optionen
        const defaultOptions = targetEl.querySelectorAll(
          'option[value="all"], option[value="loading"]'
        );
        targetEl.innerHTML = "";

        // Füge Standard-Optionen wieder hinzu
        defaultOptions.forEach((option) => targetEl.appendChild(option));

        // Füge User-Optionen hinzu (ohne den aktuellen User)
        users.forEach((user) => {
          // Überspringe den aktuellen User
          if (currentUser && user.name === currentUser) {
            return;
          }

          const option = document.createElement("option");
          option.value = user.id; // Verwende user.id als eindeutige ID!
          option.setAttribute(
            "data-display-name",
            user.displayName || user.name
          );
          option.textContent = `${user.name}`;
          targetEl.appendChild(option);
        });

        // Update User-Count (ohne den aktuellen User)
        const otherUsers = users.filter(
          (user) => !currentUser || user.name !== currentUser
        );
        onlineCount = otherUsers.length;
        userCountEl.textContent = `${onlineCount} User online • Mehrfachauswahl: Cmd/Ctrl-Klick`;

        // Entferne Loading-Option
        const loadingOption = targetEl.querySelector('option[value="loading"]');
        if (loadingOption) {
          loadingOption.remove();
        }

        // Auswahl wiederherstellen oder Standard "all"
        let restored = false;
        if (prevSelected.size > 0) {
          Array.from(targetEl.options).forEach((opt) => {
            if (prevSelected.has(opt.value)) {
              opt.selected = true;
              restored = true;
            }
          });
        }
        if (!restored || Array.from(targetEl.selectedOptions).length === 0) {
          const allOpt = Array.from(targetEl.options).find((o) => o.value === "all");
          if (allOpt) allOpt.selected = true;
        }

        // WICHTIG: Nach dem User-Loading versuchen, den Target User zu setzen
        console.log(`🎯 Dropdown updated, trying to set target user again...`);
        setTimeout(() => trySetTargetUser(), 100);
        // Initial broadcast UI state
        updateBroadcastUI();
      }

      // User beim Laden der Seite laden
      loadUsers();

      // Auto-Focus auf das Nachrichtenfeld setzen (with delay to ensure window is ready)
      setTimeout(() => {
        messageEl.focus();
        console.log(`🎯 Focus set to message field`);
      }, 100);

      // Nach User-Auswahl automatisch zurück zum Nachrichtenfeld
      // and update broadcast UI cues
      targetEl.addEventListener("change", () => {
        // Wenn "all" zusammen mit anderen gewählt wurde, entferne "all"
        const selected = Array.from(targetEl.selectedOptions).map((o) => o.value);
        if (selected.includes("all") && selected.length > 1) {
          // Deselect "all"
          const allOpt = Array.from(targetEl.options).find((o) => o.value === "all");
          if (allOpt) allOpt.selected = false;
        }
        // Wenn gar nichts gewählt ist, default "all" selektieren
        if (Array.from(targetEl.selectedOptions).length === 0) {
          const allOpt = Array.from(targetEl.options).find((o) => o.value === "all");
          if (allOpt) allOpt.selected = true;
        }
        messageEl.focus();
        console.log(`🎯 Target changed, focus back to message field`);
        try { updateBroadcastUI && updateBroadcastUI({ flash: true }); } catch(_) {}
      });

      // Refresh-Button
      refreshUsersEl.addEventListener("click", async () => {
        try {
          users = await window.compose.refreshUsers();
          updateUserDropdown();
        } catch (error) {
          console.warn("Could not refresh users:", error);
        }
      });

      function getSeverity() {
        const active = pills.querySelector(".pill.active");
        return active ? active.getAttribute("data-sev") : "info";
      }

      function validate() {
        const text = (messageEl.value || "").trim();
        const len = text.length;
        counter.textContent = `${len} / 280`;
        sendBtn.disabled = len === 0 || len > 280;
      }
      pills.addEventListener("click", (e) => {
        const p = e.target.closest(".pill");
        if (!p) return;
        pills
          .querySelectorAll(".pill")
          .forEach((x) => x.classList.remove("active"));
        p.classList.add("active");
        // Update compose bubble severity class to match selection
        try {
          const composeField = document.getElementById('composeField');
          if (composeField) {
            ['severity-blue','severity-green','severity-pink','severity-red','severity-info','severity-success','severity-warn','severity-critical']
              .forEach(cls => composeField.classList.remove(cls));
            const sev = p.getAttribute('data-sev') || 'blue';
            composeField.classList.add(`severity-${sev}`);
          }
        } catch (_) {}
        validate();
      });
      messageEl.addEventListener("input", validate);
      messageEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey && !sendBtn.disabled) {
          e.preventDefault();
          sendBtn.click();
        }
        if (e.key === "Escape") $("cancel").click();
      });
      // Prefill last severity from query
      try {
        const u = new URL(window.location.href);
        const sev = u.searchParams.get("sev");
        if (sev) {
          const target = pills.querySelector(`[data-sev="${sev}"]`);
          if (target) {
            pills
              .querySelectorAll(".pill")
              .forEach((x) => x.classList.remove("active"));
            target.classList.add("active");
            // Apply severity to compose bubble immediately on load
            try {
              const composeField = document.getElementById('composeField');
              if (composeField) {
                ['severity-blue','severity-green','severity-pink','severity-red','severity-info','severity-success','severity-warn','severity-critical']
                  .forEach(cls => composeField.classList.remove(cls));
                composeField.classList.add(`severity-${sev}`);
              }
            } catch (_) {}
          }
        }
      } catch (_) {}
      validate();

      sendBtn.addEventListener("click", () => {
        // Erzeuge Ziel: "all" oder Liste von IDs
        const selectedValues = Array.from(targetEl.selectedOptions).map((o) => o.value);
        const targetPayload =
          selectedValues.length === 0 || selectedValues.includes("all")
            ? "all"
            : selectedValues;
        window.compose.submit({
          message: messageEl.value,
          severity: getSeverity(),
          spoiler: !!spoilerEl.checked,
          target: targetPayload,
        });
      });
      $("cancel").addEventListener("click", () => window.compose.cancel());

      // Lightweight emoji panel (no dependencies)
      const EMOJIS = [
        "😀",
        "😂",
        "🤣",
        "😊",
        "😍",
        "😘",
        "😎",
        "🤔",
        "😴",
        "🙈",
        "👍",
        "👎",
        "👏",
        "🙏",
        "🙌",
        "🔥",
        "✨",
        "🎉",
        "💯",
        "✅",
        "😅",
        "😉",
        "😇",
        "🤩",
        "🥳",
        "🤗",
        "😜",
        "😡",
        "😭",
        "😷",
        "🐹",
        "🐭",
        "🐱",
        "🐶",
        "🦊",
        "🐻",
        "🐰",
        "🐼",
        "🦄",
        "🐥",
      ];
      function buildEmojiPanel() {
        if (emojiPanel.dataset.built) return;
        emojiPanel.dataset.built = "1";
        const frag = document.createDocumentFragment();
        EMOJIS.forEach((e) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "emoji-item";
          b.textContent = e;
          b.addEventListener("click", () => insertAtCursor(e));
          frag.appendChild(b);
        });
        emojiPanel.appendChild(frag);
      }
      function insertAtCursor(text) {
        const start = messageEl.selectionStart || 0;
        const end = messageEl.selectionEnd || 0;
        const val = messageEl.value || "";
        messageEl.value = val.slice(0, start) + text + val.slice(end);
        const pos = start + text.length;
        messageEl.setSelectionRange(pos, pos);
        messageEl.focus();
        validate();
      }
      function toggleEmojiPanel() {
        buildEmojiPanel();
        const isHidden = emojiPanel.classList.contains("hidden");
        if (isHidden) {
          emojiPanel.classList.remove("hidden");
          emojiPanel.setAttribute("aria-hidden", "false");
        } else {
          emojiPanel.classList.add("hidden");
          emojiPanel.setAttribute("aria-hidden", "true");
        }
      }
      emojiBtn.addEventListener("click", toggleEmojiPanel);
      document.addEventListener("mousedown", (e) => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
          emojiPanel.classList.add("hidden");
          emojiPanel.setAttribute("aria-hidden", "true");
        }
      });

      // Event-Listener für das Leeren des Eingabefelds
      window.compose.clearInput(() => {
        messageEl.value = "";
        validate();
        messageEl.focus();
      });

      // URL-Parameter für targetUser lesen
      const urlParams = new URLSearchParams(window.location.search);
      const targetFromUrl = urlParams.get("target");
      console.log(`🔍 Target from URL: ${targetFromUrl}`);

      // Event-Listener für vorausgewählten Empfänger (als Fallback)
      let pendingTargetUser = targetFromUrl;

      console.log(`🔧 Setting up setTargetUser listener...`);

      let lastTargetUser = null; // Verhindert doppelte Aufrufe

      window.compose.setTargetUser((targetUser) => {
        console.log(`🎯 setTargetUser received: targetUser=${targetUser}`);
        console.log(`🔍 targetEl element:`, targetEl);

        // Verhindere doppelte Aufrufe mit dem gleichen Wert
        if (targetUser === lastTargetUser) {
          console.log(`⏭️ Skipping duplicate targetUser: ${targetUser}`);
          return;
        }

        // Wenn der aktuelle Wert "alle" ist und der neue auch "alle" oder undefined, überspringe
        if (
          pendingTargetUser === "all" &&
          (!targetUser || targetUser === "all")
        ) {
          console.log(`⏭️ Keeping current "all" selection, no need to change`);
          return;
        }

        // Wenn targetUser ein Objekt ist, überspringe es komplett
        if (typeof targetUser === "object" && targetUser !== null) {
          console.log(`⏭️ Skipping object targetUser:`, targetUser);
          return;
        }

        lastTargetUser = targetUser;

        // Speichere den targetUser
        if (typeof targetUser === "object" && targetUser !== null) {
          console.log(
            `⚠️ targetUser is object, converting to string:`,
            targetUser
          );
          pendingTargetUser = String(targetUser);
        } else {
          pendingTargetUser = targetUser;
        }

        // Versuche sofort zu setzen
        trySetTargetUser();
      });

      console.log(`✅ setTargetUser listener set up successfully`);

      // Versuche sofort den targetUser aus der URL zu setzen
      if (targetFromUrl) {
        console.log(`🎯 Setting target user from URL: ${targetFromUrl}`);
        // Warte, bis das DOM vollständig geladen ist
        setTimeout(() => trySetTargetUser(), 500);
      }

      // Funktion zum Setzen des Target Users im Dropdown
      function trySetTargetUser() {
        console.log(
          `🔍 trySetTargetUser called with pendingTargetUser: ${pendingTargetUser}`
        );
        console.log(`🔍 targetEl element:`, targetEl);

        if (!pendingTargetUser) {
          console.log(`⏳ No pending target user`);
          return;
        }

        if (!targetEl) {
          console.log(`⏳ targetEl not available yet, retrying in 200ms...`);
          setTimeout(trySetTargetUser, 200);
          return;
        }

        console.log(`🔍 targetEl available: ${!!targetEl}`);
        console.log(`📋 targetEl options count: ${targetEl.options.length}`);

        if (targetEl.options.length === 0) {
          console.log(`⏳ targetEl has no options yet, retrying in 200ms...`);
          setTimeout(trySetTargetUser, 200);
          return;
        }

        console.log(
          `📋 targetEl options:`,
          Array.from(targetEl.options).map((opt) => opt.value)
        );

        console.log(`🔍 Looking for user: ${pendingTargetUser}`);
        // Finde den Index des Users in der Liste (nach ID oder displayName)
        for (let i = 0; i < targetEl.options.length; i++) {
          const option = targetEl.options[i];
          const optionValue = option.value;
          const optionDisplayName = option.getAttribute("data-display-name");

          console.log(
            `🔍 Option ${i}: value="${optionValue}", displayName="${optionDisplayName}"`
          );

          // Vergleiche sowohl mit user.id als auch mit displayName (für Rückwärtskompatibilität)
          if (
            optionValue === pendingTargetUser ||
            optionDisplayName === pendingTargetUser
          ) {
            console.log(
              `✅ Found match at index ${i} (matched: ${
                optionValue === pendingTargetUser ? "ID" : "displayName"
              })`
            );
            // Bei Multi-Select: andere Auswahl entfernen und nur diesen selektieren
            if (targetEl.multiple) {
              Array.from(targetEl.options).forEach((opt) => (opt.selected = false));
              option.selected = true;
            } else {
              targetEl.selectedIndex = i;
            }
            try { updateBroadcastUI && updateBroadcastUI({ flash: true }); } catch(_) {}
            pendingTargetUser = null; // Erfolgreich gesetzt
            return;
          }
        }
        console.log(`❌ User not found in dropdown: ${pendingTargetUser}`);
      }

      // Versuche es alle 200ms, bis es funktioniert
      console.log(`🔧 Setting up targetUser interval...`);
      const targetUserInterval = setInterval(() => {
        if (pendingTargetUser) {
          console.log(
            `⏰ Interval tick - trying to set target user: ${pendingTargetUser}`
          );
          trySetTargetUser();
        } else {
          console.log(`✅ Target user set, clearing interval`);
          clearInterval(targetUserInterval);
        }
      }, 200);
      console.log(`✅ targetUser interval set up successfully`);
    </script>
  </body>
</html>
