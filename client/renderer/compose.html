<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate" />
    <meta
      http-equiv="Pragma"
      content="no-cache" />
    <meta
      http-equiv="Expires"
      content="0" />
    <title>Send Toast</title>
    <style>
      :root {
        --bg: #1f2937;
        --panel: #374151;
        --muted: #9ca3af;
        --ring: #6b7280;
        --ok: #10b981;
        --warn: #f59e0b;
        --crit: #ef4444;
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: #1d2128;
        color: #afc6f3;
        display: flex;
        align-items: stretch;
      }
      .wrap {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 28px;
        width: 100%;
        height: 100%;
        justify-content: flex-start;
      }
      .header {
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #afc6f3;
        text-shadow: 0 0 10px rgba(175, 198, 243, 0.3);
      }
      .field {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: var(--radius);
        padding: 16px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .toolbar {
        position: absolute;
        top: 6px;
        right: 8px;
        display: flex;
        gap: 6px;
      }
      .btn-emoji {
        border: 0;
        background: rgba(139, 92, 246, 0.1);
        color: #a855f7;
        border-radius: 8px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-emoji:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateY(-1px);
      }
      .emoji-panel {
        position: absolute;
        top: 36px;
        right: 8px;
        width: 240px;
        background: rgba(30, 27, 75, 0.95);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 10px;
        padding: 6px;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 4px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
      }
      .emoji-panel.hidden {
        display: none;
      }
      .emoji-item {
        font-size: 18px;
        line-height: 1;
        padding: 6px;
        border: 0;
        background: transparent;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .emoji-item:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: scale(1.1);
      }
      .field:focus-within {
        outline: 2px solid #c0b4dc;
        outline-offset: 0;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
      }
      textarea {
        width: 100%;
        border: none;
        outline: none;
        resize: vertical;
        min-height: 180px;
        font-size: 14px;
        background: transparent;
        color: #e2e8f0;
        font-family: inherit;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .col {
        flex: 1;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="number"],
      select {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 10px;
        padding: 10px 12px;
        color: #e2e8f0;
      }
      .pills {
        display: flex;
        gap: 8px;
      }
      .pill {
        user-select: none;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(118, 104, 149, 0.3);
        cursor: pointer;
        font-size: 12px;
        color: #e2e8f0;
        opacity: 0.8;
        transition: all 0.2s ease;
      }
      .pill.active {
        border-color: #22173d;
        background: rgba(139, 92, 246, 0.2);
        opacity: 1;
      }
      .pill.warn.active {
        border-color: var(--warn);
        background: rgba(245, 158, 11, 0.15);
      }
      .pill.crit.active {
        border-color: var(--crit);
        background: rgba(239, 68, 68, 0.15);
      }
      .meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
      }
      button {
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .btn-secondary {
        background: rgba(139, 92, 246, 0.1);
        color: #c4b5fd;
        border: 1px solid rgba(139, 92, 246, 0.2);
        transition: all 0.2s ease;
      }

      .btn-secondary:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: translateY(-1px);
      }

      .btn-primary {
        background: #8b5cf6;
        color: #fff;
        border: 1px solid #8b5cf6;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
      }

      .btn-primary:hover {
        background: #7c3aed;
        border-color: #7c3aed;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* User-Auswahl Styles */
      .target-select {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 10px;
        padding: 10px 12px;
        color: #e2e8f0;
        font-size: 14px;
        font-family: inherit;
      }

      /* Windows-spezifische Dropdown-Styles */
      .target-select option {
        background: #1e1b4b !important;
        color: #e2e8f0 !important;
        padding: 8px 12px;
      }

      /* Hover-Effekt f√ºr Optionen */
      .target-select option:hover {
        background: #312e81 !important;
      }

      /* Focus-Effekt f√ºr Optionen */
      .target-select option:focus {
        background: #3730a3 !important;
      }

      /* Selected Option */
      .target-select option:checked {
        background: #8b5cf6 !important;
        color: #ffffff !important;
      }

      .refresh-link {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .refresh-link:hover {
        opacity: 1;
        text-decoration: underline;
      }

      .user-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 4px rgba(16, 185, 129, 0.3);
      }

      .user-status.offline {
        background: #94a3b8;
        box-shadow: 0 0 4px rgba(148, 163, 184, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">Send Toast</div>
      <div class="field">
        <div class="toolbar">
          <button
            type="button"
            id="emojiBtn"
            title="Emoji"
            class="btn-emoji">
            üòä
          </button>
          <div
            id="emojiPanel"
            class="emoji-panel hidden"
            role="menu"
            aria-hidden="true"></div>
        </div>
        <textarea
          id="message"
          placeholder="Deine Nachricht‚Ä¶ (Enter = senden)"></textarea>
        <div class="meta">
          <span id="counter">0 / 280</span>
          <span>Max. 10s</span>
        </div>
      </div>

      <!-- Neue User-Auswahl -->
      <div class="field">
        <div class="label">Empf√§nger</div>
        <select
          id="target"
          class="target-select">
          <option value="all">üë• Alle User</option>
          <option
            value="loading"
            disabled>
            üîÑ Lade User...
          </option>
        </select>
        <div class="meta">
          <span id="userCount">0 User online</span>
          <span
            id="refreshUsers"
            class="refresh-link"
            >üîÑ Aktualisieren</span
          >
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="label">Farbe</div>
          <div
            class="pills"
            id="sev-pills">
            <div
              class="pill active"
              data-sev="blue">
              blue
            </div>
            <div
              class="pill"
              data-sev="green">
              green
            </div>
            <div
              class="pill"
              data-sev="pink">
              pink
            </div>
            <div
              class="pill crit"
              data-sev="red">
              red
            </div>
          </div>
        </div>
        <div class="col">
          <div class="label">Duration (ms)</div>
          <input
            id="duration"
            type="number"
            min="500"
            max="10000"
            value="3000" />
        </div>
      </div>

      <div class="actions">
        <button
          class="btn-secondary"
          id="cancel">
          Abbrechen
        </button>
        <button
          class="btn-primary"
          id="send"
          disabled>
          Senden
        </button>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const messageEl = $("message");
      const durationEl = $("duration");
      const sendBtn = $("send");
      const counter = $("counter");
      const pills = document.getElementById("sev-pills");
      const emojiBtn = document.getElementById("emojiBtn");
      const emojiPanel = document.getElementById("emojiPanel");
      const targetEl = $("target");
      const userCountEl = $("userCount");
      const refreshUsersEl = $("refreshUsers");

      // User-Management
      let users = [];
      let currentUser = null;

      async function loadUsers() {
        try {
          // Lade User √ºber IPC (kein CORS-Problem)
          users = await window.compose.loadUsers();
          // Lade aktuellen User-Namen
          currentUser = await window.compose.getCurrentUser();
          updateUserDropdown();
        } catch (error) {
          console.warn("Could not load users:", error);
          setDefaultUsers();
        }
      }

      function setDefaultUsers() {
        users = [];
        currentUser = null;
        updateUserDropdown();
      }

      function updateUserDropdown() {
        // Entferne alle User-Optionen au√üer den Standard-Optionen
        const defaultOptions = targetEl.querySelectorAll(
          'option[value="all"], option[value="loading"]'
        );
        targetEl.innerHTML = "";

        // F√ºge Standard-Optionen wieder hinzu
        defaultOptions.forEach((option) => targetEl.appendChild(option));

        // F√ºge User-Optionen hinzu (ohne den aktuellen User)
        users.forEach((user) => {
          // √úberspringe den aktuellen User
          if (currentUser && user.name === currentUser) {
            return;
          }

          const option = document.createElement("option");
          option.value = user.id; // Verwende user.id als eindeutige ID!
          option.setAttribute(
            "data-display-name",
            user.displayName || user.name
          );
          option.innerHTML = `
            <div class="user-option">
              <span class="user-status ${
                user.status === "online" ? "" : "offline"
              }"></span>
              ${user.name}
            </div>
          `;
          targetEl.appendChild(option);
        });

        // Update User-Count (ohne den aktuellen User)
        const otherUsers = users.filter(
          (user) => !currentUser || user.name !== currentUser
        );
        userCountEl.textContent = `${otherUsers.length} andere User online`;

        // Entferne Loading-Option
        const loadingOption = targetEl.querySelector('option[value="loading"]');
        if (loadingOption) {
          loadingOption.remove();
        }

        // WICHTIG: Nach dem User-Loading versuchen, den Target User zu setzen
        console.log(`üéØ Dropdown updated, trying to set target user again...`);
        setTimeout(() => trySetTargetUser(), 100);
      }

      // User beim Laden der Seite laden
      loadUsers();

      // Auto-Focus auf das Nachrichtenfeld setzen
      messageEl.focus();

      // Nach User-Auswahl automatisch zur√ºck zum Nachrichtenfeld
      targetEl.addEventListener("change", () => {
        messageEl.focus();
        console.log(`üéØ Target changed, focus back to message field`);
      });

      // Refresh-Button
      refreshUsersEl.addEventListener("click", async () => {
        try {
          users = await window.compose.refreshUsers();
          updateUserDropdown();
        } catch (error) {
          console.warn("Could not refresh users:", error);
        }
      });

      function getSeverity() {
        const active = pills.querySelector(".pill.active");
        return active ? active.getAttribute("data-sev") : "info";
      }
      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }
      function validate() {
        const text = (messageEl.value || "").trim();
        const len = text.length;
        counter.textContent = `${len} / 280`;
        const dur = clamp(Number(durationEl.value || 3000), 500, 10000);
        durationEl.value = String(dur);
        sendBtn.disabled = len === 0 || len > 280;
      }
      pills.addEventListener("click", (e) => {
        const p = e.target.closest(".pill");
        if (!p) return;
        pills
          .querySelectorAll(".pill")
          .forEach((x) => x.classList.remove("active"));
        p.classList.add("active");
        validate();
      });
      messageEl.addEventListener("input", validate);
      durationEl.addEventListener("input", validate);
      messageEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey && !sendBtn.disabled) {
          e.preventDefault();
          sendBtn.click();
        }
        if (e.key === "Escape") $("cancel").click();
      });
      // Prefill last severity from query
      try {
        const u = new URL(window.location.href);
        const sev = u.searchParams.get("sev");
        if (sev) {
          const target = pills.querySelector(`[data-sev="${sev}"]`);
          if (target) {
            pills
              .querySelectorAll(".pill")
              .forEach((x) => x.classList.remove("active"));
            target.classList.add("active");
          }
        }
      } catch (_) {}
      validate();

      sendBtn.addEventListener("click", () => {
        window.compose.submit({
          message: messageEl.value,
          severity: getSeverity(),
          duration: Number(durationEl.value || 3000),
          target: targetEl.value || "all",
        });
      });
      $("cancel").addEventListener("click", () => window.compose.cancel());

      // Lightweight emoji panel (no dependencies)
      const EMOJIS = [
        "üòÄ",
        "üòÇ",
        "ü§£",
        "üòä",
        "üòç",
        "üòò",
        "üòé",
        "ü§î",
        "üò¥",
        "üôà",
        "üëç",
        "üëé",
        "üëè",
        "üôè",
        "üôå",
        "üî•",
        "‚ú®",
        "üéâ",
        "üíØ",
        "‚úÖ",
        "üòÖ",
        "üòâ",
        "üòá",
        "ü§©",
        "ü•≥",
        "ü§ó",
        "üòú",
        "üò°",
        "üò≠",
        "üò∑",
        "üêπ",
        "üê≠",
        "üê±",
        "üê∂",
        "ü¶ä",
        "üêª",
        "üê∞",
        "üêº",
        "ü¶Ñ",
        "üê•",
      ];
      function buildEmojiPanel() {
        if (emojiPanel.dataset.built) return;
        emojiPanel.dataset.built = "1";
        const frag = document.createDocumentFragment();
        EMOJIS.forEach((e) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "emoji-item";
          b.textContent = e;
          b.addEventListener("click", () => insertAtCursor(e));
          frag.appendChild(b);
        });
        emojiPanel.appendChild(frag);
      }
      function insertAtCursor(text) {
        const start = messageEl.selectionStart || 0;
        const end = messageEl.selectionEnd || 0;
        const val = messageEl.value || "";
        messageEl.value = val.slice(0, start) + text + val.slice(end);
        const pos = start + text.length;
        messageEl.setSelectionRange(pos, pos);
        messageEl.focus();
        validate();
      }
      function toggleEmojiPanel() {
        buildEmojiPanel();
        const isHidden = emojiPanel.classList.contains("hidden");
        if (isHidden) {
          emojiPanel.classList.remove("hidden");
          emojiPanel.setAttribute("aria-hidden", "false");
        } else {
          emojiPanel.classList.add("hidden");
          emojiPanel.setAttribute("aria-hidden", "true");
        }
      }
      emojiBtn.addEventListener("click", toggleEmojiPanel);
      document.addEventListener("mousedown", (e) => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
          emojiPanel.classList.add("hidden");
          emojiPanel.setAttribute("aria-hidden", "true");
        }
      });

      // Event-Listener f√ºr das Leeren des Eingabefelds
      window.compose.clearInput(() => {
        messageEl.value = "";
        validate();
        messageEl.focus();
      });

      // URL-Parameter f√ºr targetUser lesen
      const urlParams = new URLSearchParams(window.location.search);
      const targetFromUrl = urlParams.get("target");
      console.log(`üîç Target from URL: ${targetFromUrl}`);

      // Event-Listener f√ºr vorausgew√§hlten Empf√§nger (als Fallback)
      let pendingTargetUser = targetFromUrl;

      console.log(`üîß Setting up setTargetUser listener...`);

      let lastTargetUser = null; // Verhindert doppelte Aufrufe

      window.compose.setTargetUser((targetUser) => {
        console.log(`üéØ setTargetUser received: targetUser=${targetUser}`);
        console.log(`üîç targetEl element:`, targetEl);

        // Verhindere doppelte Aufrufe mit dem gleichen Wert
        if (targetUser === lastTargetUser) {
          console.log(`‚è≠Ô∏è Skipping duplicate targetUser: ${targetUser}`);
          return;
        }

        // Wenn der aktuelle Wert "alle" ist und der neue auch "alle" oder undefined, √ºberspringe
        if (
          pendingTargetUser === "all" &&
          (!targetUser || targetUser === "all")
        ) {
          console.log(`‚è≠Ô∏è Keeping current "all" selection, no need to change`);
          return;
        }

        lastTargetUser = targetUser;

        // Speichere den targetUser
        if (typeof targetUser === "object" && targetUser !== null) {
          console.log(
            `‚ö†Ô∏è targetUser is object, converting to string:`,
            targetUser
          );
          pendingTargetUser = String(targetUser);
        } else {
          pendingTargetUser = targetUser;
        }

        // Versuche sofort zu setzen
        trySetTargetUser();
      });

      console.log(`‚úÖ setTargetUser listener set up successfully`);

      // Versuche sofort den targetUser aus der URL zu setzen
      if (targetFromUrl) {
        console.log(`üéØ Setting target user from URL: ${targetFromUrl}`);
        // Warte, bis das DOM vollst√§ndig geladen ist
        setTimeout(() => trySetTargetUser(), 500);
      }

      // Funktion zum Setzen des Target Users im Dropdown
      function trySetTargetUser() {
        console.log(
          `üîç trySetTargetUser called with pendingTargetUser: ${pendingTargetUser}`
        );
        console.log(`üîç targetEl element:`, targetEl);

        if (!pendingTargetUser) {
          console.log(`‚è≥ No pending target user`);
          return;
        }

        if (!targetEl) {
          console.log(`‚è≥ targetEl not available yet, retrying in 200ms...`);
          setTimeout(trySetTargetUser, 200);
          return;
        }

        console.log(`üîç targetEl available: ${!!targetEl}`);
        console.log(`üìã targetEl options count: ${targetEl.options.length}`);

        if (targetEl.options.length === 0) {
          console.log(`‚è≥ targetEl has no options yet, retrying in 200ms...`);
          setTimeout(trySetTargetUser, 200);
          return;
        }

        console.log(
          `üìã targetEl options:`,
          Array.from(targetEl.options).map((opt) => opt.value)
        );

        console.log(`üîç Looking for user: ${pendingTargetUser}`);
        // Finde den Index des Users in der Liste (nach ID oder displayName)
        for (let i = 0; i < targetEl.options.length; i++) {
          const option = targetEl.options[i];
          const optionValue = option.value;
          const optionDisplayName = option.getAttribute("data-display-name");

          console.log(
            `üîç Option ${i}: value="${optionValue}", displayName="${optionDisplayName}"`
          );

          // Vergleiche sowohl mit user.id als auch mit displayName (f√ºr R√ºckw√§rtskompatibilit√§t)
          if (
            optionValue === pendingTargetUser ||
            optionDisplayName === pendingTargetUser
          ) {
            console.log(
              `‚úÖ Found match at index ${i} (matched: ${
                optionValue === pendingTargetUser ? "ID" : "displayName"
              })`
            );
            targetEl.selectedIndex = i;
            pendingTargetUser = null; // Erfolgreich gesetzt
            return;
          }
        }
        console.log(`‚ùå User not found in dropdown: ${pendingTargetUser}`);
      }

      // Versuche es alle 200ms, bis es funktioniert
      console.log(`üîß Setting up targetUser interval...`);
      const targetUserInterval = setInterval(() => {
        if (pendingTargetUser) {
          console.log(
            `‚è∞ Interval tick - trying to set target user: ${pendingTargetUser}`
          );
          trySetTargetUser();
        } else {
          console.log(`‚úÖ Target user set, clearing interval`);
          clearInterval(targetUserInterval);
        }
      }, 200);
      console.log(`‚úÖ targetUser interval set up successfully`);
    </script>
  </body>
</html>
